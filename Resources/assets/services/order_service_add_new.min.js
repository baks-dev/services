LimitNewOrderService=5;DeletedNewOrderServiceItems=new Map;IndexOrderService=0;executeFunc(function newAddOrderService(){if(typeof htmx==="undefined"||htmx===null){return false}let addElementCollectionFormAButton=document.getElementById("collapse_new_order_form_serv");if(addElementCollectionFormAButton==="undefined"||addElementCollectionFormAButton===null){return false}const addOrderServiceForm=document.forms.add_order_service_to_order_form;if(typeof addOrderServiceForm==="undefined"||addOrderServiceForm===null){htmx.ajax("GET",addElementCollectionFormAButton.getAttribute("hx-get"),{target:addElementCollectionFormAButton});return false}const hideCollapseAButton=addOrderServiceForm.querySelector('[data-bs-dismiss="collapse"]');if(typeof hideCollapseAButton==="undefined"||hideCollapseAButton===null){return false}hideCollapseAButton.addEventListener("click",function(){let collapse=bootstrap.Collapse.getOrCreateInstance(addElementCollectionFormAButton);collapse.hide()});document.querySelector(".modal-header").addEventListener("mouseenter",e=>{if(!addElementCollectionFormAButton.classList.contains("show")){return}else{let collapse=bootstrap.Collapse.getOrCreateInstance(addElementCollectionFormAButton);collapse.hide()}});const orderService=document.getElementById(addOrderServiceForm.name+"_serv");if(typeof orderService==="undefined"||orderService===null){return false}orderService.addEventListener("change",function(event){changeOrderService(addOrderServiceForm)});return true},800);async function changeOrderService(form){const data=new FormData(form);data.delete(form.name+"[_token]");data.delete(form.name+"[name]");data.delete(form.name+"[price]");data.delete(form.name+"[time]");await fetch(form.action,{method:form.method,cache:"no-cache",credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"},redirect:"follow",referrerPolicy:"no-referrer",body:data}).then(response=>{if(response.status!==200){return false}return response.text()}).then(data=>{if(data){const result=parseFormData(data);let nameFormField=result.getElementById("add_order_service_to_order_form_name");if(nameFormField.value===""){document.getElementById("field_name")&&(document.getElementById("field_name").innerHTML="");document.getElementById("field_price")&&(document.getElementById("field_price").innerHTML="");document.getElementById("field_date")&&(document.getElementById("field_date").innerHTML="");document.getElementById("field_period")&&(document.getElementById("field_period").innerHTML="");document.getElementById("add_order_service_to_order_form_order_service_add")&&document.getElementById("add_order_service_to_order_form_order_service_add").remove();return}if(nameFormField&&nameFormField.value!==""){document.getElementById("field_name").replaceWith(result.getElementById("field_name"))}let priceFormField=result.getElementById("add_order_service_to_order_form_price");if(priceFormField&&priceFormField.type!=="hidden"){fieldReplace(document.getElementById("field_price"),result.getElementById("field_price"))}let dateFormField=result.getElementById("add_order_service_to_order_form_date");if(dateFormField&&dateFormField.type!=="hidden"){fieldReplace(document.getElementById("field_date"),result.getElementById("field_date"));initDatapicker(dateFormField)}let periodFormField=result.getElementById("add_order_service_to_order_form_period");if(periodFormField&&periodFormField.type!=="hidden"){fieldReplace(document.getElementById("field_period"),result.getElementById("field_period"));const period=document.getElementById("add_order_service_to_order_form_period");period.addEventListener("change",function(event){let form=this.closest("form");changeOrderService(form)})}const service_buttons=document.getElementById("service_buttons");const addButton=result.getElementById("add_order_service_to_order_form_order_service_add");if(addButton&&!document.getElementById("add_order_service_to_order_form_order_service_add")&&false===periodFormField.classList.contains("is-invalid")){service_buttons.append(addButton);addButton.addEventListener("click",function(event){let form=this.closest("form");addOrderService(form)})}}})}function addOrderService(form){const collectionControls=document.getElementById("service_collcetion_controls");const formNameToAdd=collectionControls.querySelector("a").dataset.form;const serviceCollection=document.getElementById("service_сollection_new_order");const addCollectionButton=document.getElementById(`add_item_`+formNameToAdd);IndexOrderService=addCollectionButton.dataset.index;if(DeletedNewOrderServiceItems.size>0){let last="";DeletedNewOrderServiceItems.forEach(function(value){last=value});IndexOrderService=last;DeletedNewOrderServiceItems.delete("key"+last)}const prototypeName=addCollectionButton.dataset.prototype;const prototypeElement=document.getElementById(prototypeName);let prototypeContent=prototypeElement.dataset.prototype;let index=parseInt(addCollectionButton.dataset.index)+1;addCollectionButton.setAttribute("data-index",index);if(parseInt(addCollectionButton.dataset.index)>LimitNewOrderService){addCollectionButton.setAttribute("data-index",LimitNewOrderService);return}prototypeContent=prototypeContent.replace(/__service__/g,IndexOrderService);const result=parseFormData(prototypeContent);const prototypItem=result.getElementById("prototypeItem").querySelector(".item-service");let prototypId=prototypItem.querySelector(`.`+formNameToAdd+`_`+`${IndexOrderService}`+`_serv`);let prototypName=prototypItem.querySelector(`.`+formNameToAdd+`_`+`${IndexOrderService}`+`_name`);let prototypDate=prototypItem.querySelector(`.`+formNameToAdd+`_`+`${IndexOrderService}`+`_date`);let prototypPeriod=prototypItem.querySelector(`.`+formNameToAdd+`_`+`${IndexOrderService}`+`_period`);let prototypPrice=prototypItem.querySelector(`.`+formNameToAdd+`_`+`${IndexOrderService}`+`_money`);const formData=Object.fromEntries(new FormData(form).entries());const formId=formData["add_order_service_to_order_form[serv]"];const formName=formData["add_order_service_to_order_form[name]"];const formDate=formData["add_order_service_to_order_form[date]"];const formPeriod=formData["add_order_service_to_order_form[period]"].split("_");const formPeriodUid=formPeriod[0];const formPeriodText=formPeriod[1];const formPrice=formData["add_order_service_to_order_form[price]"];const minPrice=form.elements["add_order_service_to_order_form[price]"].dataset.min;prototypPrice.setAttribute("data-min",minPrice);let prototypeIdParentTd=prototypId.closest("td");prototypeIdParentTd.append(formName);let prototypePeriodParentTd=prototypPeriod.closest("td");prototypePeriodParentTd.append(formPeriodText);let prototypeDateParentTd=prototypDate.closest("td");prototypeDateParentTd.append(formDate);prototypId.value=formId;prototypName.value=formName;prototypDate.value=formDate;prototypPrice.value=formPrice;prototypPeriod.value=formPeriodUid;prototypPeriod.textContent=formPeriodText;if(false===isOrderServiceUnique(formId,formDate,formPeriodUid)){let noticeToast='{ "type":"danger" , '+'"header":"Ошибка при добавлении услуги в заказ"  , '+`"message" : "Услуга с названием `+formName+`, датой `+formDate+`, периодом `+formPeriodText+` уже добавлена" }`;createToast(JSON.parse(noticeToast));return}serviceCollection.append(prototypItem);if(document.body.contains(prototypItem)){deleteOrderServiceItem(prototypItem);changeOrderServicePriceByClick(prototypItem)}let Collapse=document.getElementById("add_item_new_order_form_serv");if(Collapse){Collapse.click()}}function isOrderServiceUnique(servValue,dateValue,periodValue){const rows=document.querySelectorAll("#service_сollection_new_order tr");for(const row of rows){const servInput=row.querySelector('input[name*="[serv]"]');const dateInput=row.querySelector('input[name*="[date]"]');let periodEl=row.querySelector('select[name*="[period]"]');if(!periodEl){periodEl=row.querySelector('input[name*="[period]"]')}if(!servInput||!dateInput||!periodEl){continue}const existingServ=servInput.value;const existingDate=dateInput.value;const existingPeriod=periodEl.value;if(existingServ===servValue&&existingDate===dateValue&&existingPeriod===periodValue){return false}}return true}function changeOrderServicePriceByClick(element){element.querySelectorAll(".order-service-price-minus").forEach(function(btn){btn.addEventListener("click",function(){let priceInput=document.getElementById(this.dataset.id);let result=parseFloat(priceInput.value.replace(",","."));result=result-(this.dataset.step?this.dataset.step*1:1);if(priceInput.dataset.min){let min=parseFloat(priceInput.dataset.min.replace(",","."));if(result<min){return}}if(result<=0){return}priceInput.value=result})});element.querySelectorAll(".order-service-price-plus").forEach(function(btn){btn.addEventListener("click",function(){let priceInput=document.getElementById(this.dataset.id);let result=parseFloat(priceInput.value.replace(",","."));result=result+(this.dataset.step?this.dataset.step*1:1);if(priceInput.dataset.max&&result>priceInput.dataset.max){return}priceInput.value=result})})}function deleteOrderServiceItem(element){element.querySelectorAll(".del-item-service").forEach(function(btn){btn.addEventListener("click",function(){let deteteItemId=btn.id.replace(/delete-/g,"");const itemForDelete=document.getElementById(deteteItemId);const deleteIndex=btn.id.replace(/delete-order_form_service-/g,"");DeletedNewOrderServiceItems.set("key"+deleteIndex,deleteIndex);if(itemForDelete){let addBtn=document.getElementById("add_item_new_order_form_serv");const newIndex=parseInt(addBtn.dataset.index)-1;addBtn.setAttribute("data-index",newIndex);itemForDelete.remove()}})})}function initDatapicker(field){const datepicker=MCDatepicker.create({el:"#"+field.id,bodyType:"modal",autoClose:false,closeOndblclick:true,closeOnBlur:false,customOkBTN:"OK",customClearBTN:datapickerLang[$locale].customClearBTN,customCancelBTN:datapickerLang[$locale].customCancelBTN,firstWeekday:datapickerLang[$locale].firstWeekday,dateFormat:"DD.MM.YYYY",customWeekDays:datapickerLang[$locale].customWeekDays,customMonths:datapickerLang[$locale].customMonths,minDate:new Date});const addOrderServiceForm=document.forms.add_order_service_to_order_form;datepicker.onSelect(function(date,formatedDate){changeOrderService(addOrderServiceForm)})}function parseFormData(data){const parser=new DOMParser;return parser.parseFromString(data,"text/html")}function fieldReplace(oldField,newField){newField.classList.add("fade");oldField.replaceWith(newField);void newField.offsetWidth;newField.classList.add("show")}