LimitIEditOrderService=6;DeletedIEditOrderService=new Map;IndexEditOrderService=0;executeFunc(function editAddOrderService(){const orderServiceCollection=document.getElementById("service_сollection_edit_order");if(typeof orderServiceCollection==="undefined"||orderServiceCollection===null){return false}if(orderServiceCollection.getAttribute("usage")===null){changeOrderServiceSumByInput(orderServiceCollection);changeOrderServiceSumByClick(orderServiceCollection);deleteOrderServiceItem(orderServiceCollection);initDatapickerAll();orderServiceCollection.setAttribute("usage","true");return true}const addOrderServiceButton=document.getElementById("add_item_edit_order_form_serv");if(typeof addOrderServiceButton==="undefined"||addOrderServiceButton===null){return false}const addOrderServiceForm=document.forms.add_order_service_to_order_form;if(typeof addOrderServiceForm==="undefined"||addOrderServiceForm===null){return false}let OrderService=document.getElementById(addOrderServiceForm.name+"_serv");if(typeof OrderService==="undefined"||OrderService===null){return false}OrderService.addEventListener("change",function(event){changeOrderService(addOrderServiceForm)});return true});async function changeOrderService(form){const data=new FormData(form);data.delete(form.name+"[_token]");data.delete(form.name+"[name]");data.delete(form.name+"[price]");data.delete(form.name+"[time]");await fetch(form.action,{method:form.method,cache:"no-cache",credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"},redirect:"follow",referrerPolicy:"no-referrer",body:data}).then(response=>{if(response.status!==200){return false}return response.text()}).then(data=>{if(data){const result=parseFormData(data);let nameFormField=result.getElementById("add_order_service_to_order_form_name");if(nameFormField.value===""){document.getElementById("field_name")&&(document.getElementById("field_name").innerHTML="");document.getElementById("field_price")&&(document.getElementById("field_price").innerHTML="");document.getElementById("field_date")&&(document.getElementById("field_date").innerHTML="");document.getElementById("field_period")&&(document.getElementById("field_period").innerHTML="");document.getElementById("add_order_service_to_order_form_order_service_add")&&document.getElementById("add_order_service_to_order_form_order_service_add").remove();return}if(nameFormField&&nameFormField.value){document.getElementById("field_name").replaceWith(result.getElementById("field_name"))}let priceFormField=result.getElementById("add_order_service_to_order_form_price");serviceMlfinPrice=priceFormField.dataset.min;if(priceFormField&&priceFormField.type!=="hidden"){fieldReplace(document.getElementById("field_price"),result.getElementById("field_price"))}let dateFormField=result.getElementById("add_order_service_to_order_form_date");if(dateFormField&&dateFormField.type!=="hidden"){fieldReplace(document.getElementById("field_date"),result.getElementById("field_date"));initDatapickerForField(dateFormField)}let periodFormField=result.getElementById("add_order_service_to_order_form_period");if(periodFormField&&periodFormField.type!=="hidden"){fieldReplace(document.getElementById("field_period"),result.getElementById("field_period"));const period=document.getElementById("add_order_service_to_order_form_period");period.addEventListener("change",function(event){let form=this.closest("form");changeOrderService(form)})}const service_buttons=document.getElementById("service_buttons");const addButton=result.getElementById("add_order_service_to_order_form_order_service_add");if(addButton&&!document.getElementById("add_order_service_to_order_form_order_service_add")&&false===periodFormField.classList.contains("is-invalid")){service_buttons.append(addButton);addButton.addEventListener("click",function(event){let form=this.closest("form");submitOrderService(form)})}}})}async function submitOrderService(form){const data=new FormData(form);await fetch(form.action,{method:form.method,cache:"no-cache",credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"},redirect:"follow",referrerPolicy:"no-referrer",body:data}).then(response=>{if(response.status!==200){return false}const contentType=response.headers.get("content-type");if(contentType!=="application/json"){return false}return response.json()}).then(result=>{if(result.valid===true){const collectionControls=document.getElementById("service_collcetion_controls");const formNameToAdd=collectionControls.querySelector("a").dataset.form;const serviceCollection=document.getElementById("service_сollection_edit_order");const addCollectionButton=document.getElementById(`add_item_`+formNameToAdd);if(addCollectionButton){IndexEditOrderService=addCollectionButton.dataset.index}if(DeletedIEditOrderService.size>0){let last="";DeletedIEditOrderService.forEach(function(value){last=value});AvitoKitCollectionItemKey=last;DeletedIEditOrderService.delete("key"+last)}const prototypeName=addCollectionButton.dataset.prototype;const prototypeElement=document.getElementById(prototypeName);let prototypeContent=prototypeElement.dataset.prototype;let index=parseInt(addCollectionButton.dataset.index)+1;addCollectionButton.setAttribute("data-index",index);if(parseInt(addCollectionButton.dataset.index)>LimitIEditOrderService){addCollectionButton.setAttribute("data-index",LimitIEditOrderService);return}prototypeContent=prototypeContent.replace(/__service__/g,IndexEditOrderService);const result=parseFormData(prototypeContent);const prototypItem=result.getElementById("prototypeItem").querySelector(".item-service");let prototypId=prototypItem.querySelector(`.`+formNameToAdd+`_`+`${IndexEditOrderService}`+`_serv`);let prototypName=prototypItem.querySelector(`.`+formNameToAdd+`_`+`${IndexEditOrderService}`+`_name`);let prototypDate=prototypItem.querySelector(`.`+formNameToAdd+`_`+`${IndexEditOrderService}`+`_date`);let prototypPeriod=prototypItem.querySelector(`.`+formNameToAdd+`_`+`${IndexEditOrderService}`+`_period`);let prototypPrice=prototypItem.querySelector(`.`+formNameToAdd+`_`+`${IndexEditOrderService}`+`_money`);const formData=Object.fromEntries(data.entries());const formId=formData["add_order_service_to_order_form[serv]"];const formName=formData["add_order_service_to_order_form[name]"];const formDate=formData["add_order_service_to_order_form[date]"];const formPeriodUid=formData["add_order_service_to_order_form[period]"];const formPrice=formData["add_order_service_to_order_form[price]"];const formPeriodEl=form.elements["add_order_service_to_order_form[period]"];const selectedPeriod=formPeriodEl.options[formPeriodEl.selectedIndex];const formPeriodTime=selectedPeriod.dataset.time;prototypPrice.setAttribute("data-min",formPrice);let idPrototypeParentEl=prototypId.closest("td");idPrototypeParentEl.append(formName);let periodPrototypeParentEl=prototypPeriod.closest("td");periodPrototypeParentEl.append(formPeriodTime);let datePrototypeParentEl=prototypDate.closest("td");datePrototypeParentEl.append(formDate);prototypId.value=formId;prototypName.value=formName;prototypDate.value=formDate;prototypPrice.value=formPrice;prototypPeriod.value=formPeriodUid;prototypPeriod.textContent=formPeriodTime;if(false===isOrderServiceUnique(formId,formDate,formPeriodUid)){let Modal=document.getElementById("modal");let modalInstance=bootstrap.Modal.getInstance(Modal);modalInstance.hide();let noticeToast='{ "type":"danger" , '+'"header":"Ошибка при добавлении услуги в заказ"  , '+`"message" : "Услуга с названием `+formName+`, датой `+formDate+`, периодом `+formPeriodTime+` уже добавлена" }`;createToast(JSON.parse(noticeToast));return}serviceCollection.append(prototypItem);if(document.body.contains(prototypItem)){let Modal=document.getElementById("modal");let modalInstance=bootstrap.Modal.getInstance(Modal);modalInstance.hide();changeOrderServiceSumByInput(prototypItem);changeOrderServiceSumByClick(prototypItem);deleteOrderServiceItem(prototypItem);let result=parseFloat(formPrice.replace(",","."));modifyTotalOrderSum()}}})}function isOrderServiceUnique(servValue,dateValue,periodValue){const rows=document.querySelectorAll("#service_сollection_edit_order tr");for(const row of rows){const servInput=row.querySelector('input[name*="[serv]"]');const dateInput=row.querySelector('input[name*="[date]"]');let periodEl=row.querySelector('select[name*="[period]"]');if(!periodEl){periodEl=row.querySelector('input[name*="[period]"]')}if(!servInput||!dateInput||!periodEl){continue}const existingServ=servInput.value;const existingDate=dateInput.value;const existingPeriod=periodEl.value;if(existingServ===servValue&&existingDate===dateValue&&existingPeriod===periodValue){return false}}return true}function changeOrderServiceSumByInput(element){element.querySelectorAll(".order-service-price").forEach(function(input){let timer;input.addEventListener("input",function(event){clearTimeout(timer);timer=setTimeout(()=>{modifyTotalOrderSum()},1e3)})})}function changeOrderServiceSumByClick(element){element.querySelectorAll(".order-service-price-minus").forEach(function(btn){btn.addEventListener("click",function(){let priceInput=document.getElementById(this.dataset.id);let result=parseFloat(priceInput.value.replace(",","."));result=result-(this.dataset.step?this.dataset.step*1:1);if(priceInput.dataset.min){let min=parseFloat(priceInput.dataset.min.replace(",","."));if(result<min){return}}if(result<=0){return}priceInput.value=result;modifyTotalOrderSum()})});element.querySelectorAll(".order-service-price-plus").forEach(function(btn){btn.addEventListener("click",function(){let priceInput=document.getElementById(this.dataset.id);let result=parseFloat(priceInput.value.replace(",","."));result=result+(this.dataset.step?this.dataset.step*1:1);if(priceInput.dataset.max&&result>priceInput.dataset.max){return}priceInput.value=result;modifyTotalOrderSum()})})}function modifyTotalOrderSum(){let serviceCollection=document.getElementById("service_сollection_edit_order");let serviceSumEl=document.getElementById("service_sum");let serviceSumResult=0;serviceCollection.querySelectorAll(".order-service-price").forEach(function(input){let inputPriceInt=parseInt(input.value,10);const priceMin=parseInt(input.dataset.min,10);if(inputPriceInt<priceMin||Number.isNaN(inputPriceInt)){let noticeToast='{ "type":"danger" , '+'"header":"Ошибка при изменении стоимости"  , '+`"message" : "Минимальная стоимость услуги `+`${priceMin}`+` ₽" }`;createToast(JSON.parse(noticeToast));input.value=priceMin;inputPriceInt=priceMin}serviceSumResult+=inputPriceInt});let serviceSumFormatted=serviceSumResult.toLocaleString("ru-RU")+" ₽";serviceSumEl.textContent=serviceSumFormatted;let totalAllSumEl=document.getElementById("total_all_sum");let productSum=document.getElementById("total_product_sum");let productSumParse=productSum.textContent.replace(/[^\d]/g,"");let productSumInt=parseInt(productSumParse,10);let serviceSumParse=serviceSumEl.textContent.replace(/[^\d]/g,"");let serviceSumInt=parseInt(serviceSumParse,10);const totalAllSumRes=productSumInt+serviceSumInt;const totalSumFormatted=totalAllSumRes.toLocaleString("ru-RU")+" ₽";totalAllSumEl.textContent=totalSumFormatted}function deleteOrderServiceItem(element){element.querySelectorAll(".del-item-service").forEach(function(btn){btn.addEventListener("click",function(){let deteteItemId=btn.id.replace(/delete-/g,"");const itemForDelete=document.getElementById(deteteItemId);const deleteIndex=btn.id.replace(/delete-order_form_service-/g,"");DeletedIEditOrderService.set("key"+deleteIndex,deleteIndex);if(itemForDelete){let addBtn=document.getElementById("add_item_edit_order_form_serv");const newIndex=parseInt(addBtn.dataset.index)-1;addBtn.setAttribute("data-index",newIndex);itemForDelete.remove();modifyTotalOrderSum()}})})}function initDatapickerForField(field){const datepicker=MCDatepicker.create({el:"#"+field.id,bodyType:"modal",autoClose:false,closeOndblclick:true,closeOnBlur:false,customOkBTN:"OK",customClearBTN:datapickerLang[$locale].customClearBTN,customCancelBTN:datapickerLang[$locale].customCancelBTN,firstWeekday:datapickerLang[$locale].firstWeekday,dateFormat:"DD.MM.YYYY",customWeekDays:datapickerLang[$locale].customWeekDays,customMonths:datapickerLang[$locale].customMonths,minDate:new Date});const addOrderServiceForm=document.forms.add_order_service_to_order_form;datepicker.onSelect(function(date,formatedDate){changeOrderService(addOrderServiceForm)})}function initDatapickerAll(){const rows=document.querySelectorAll("#service_сollection_edit_order tr");for(const row of rows){const dateInput=row.querySelector('input[name*="[date]"]');if(!dateInput){continue}let x9y7P90sZsRepeat=100;setTimeout(function x9y7P90sZs(){if(x9y7P90sZs>=1e3){return}if(typeof MCDatepicker==="object"){const[day,month,year]=dateInput.value.split(".");$selectedDate=new Date(+year,month-1,+day);let currentDate=new Date;const nextDay=new Date(currentDate.setDate(currentDate.getDate()));currentDate=new Date;const limitDay=new Date(currentDate.setDate(currentDate.getDate()+7));const datepicker=MCDatepicker.create({el:"#"+dateInput.id,bodyType:"modal",autoClose:false,closeOndblclick:true,closeOnBlur:false,customOkBTN:"OK",customClearBTN:datapickerLang[$locale].customClearBTN,customCancelBTN:datapickerLang[$locale].customCancelBTN,firstWeekday:datapickerLang[$locale].firstWeekday,dateFormat:"DD.MM.YYYY",customWeekDays:datapickerLang[$locale].customWeekDays,customMonths:datapickerLang[$locale].customMonths,selectedDate:$selectedDate,minDate:nextDay,maxDate:limitDay});const editOrderForm=document.forms.edit_order_form;datepicker.onSelect(function(date,formatedDate){let dateFieldId=dateInput.id;updateServicePeriodField(editOrderForm,dateFieldId)});return}x9y7P90sZsRepeat=x9y7P90sZsRepeat*2;setTimeout(x9y7P90sZs,100)},100)}}async function updateServicePeriodField(form,fieldId){const data=new FormData(form);data.delete(form.name+"[_token]");await fetch(form.action,{method:form.method,cache:"no-cache",credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"},redirect:"follow",referrerPolicy:"no-referrer",body:data}).then(response=>{if(response.status!==200){return false}return response.text()}).then(data=>{const periodFieldId=fieldId.replace("date","period");const result=parseFormData(data);let collection=result.getElementById("service_сollection_edit_order");let resultPeriod=result.getElementById(periodFieldId);let currentPeriod=document.getElementById(periodFieldId);if(currentPeriod&&resultPeriod){fieldReplace(currentPeriod,resultPeriod)}})}function parseFormData(data){const parser=new DOMParser;return parser.parseFromString(data,"text/html")}function fieldReplace(oldField,newField){newField.classList.add("fade");oldField.replaceWith(newField);void newField.offsetWidth;newField.classList.add("show")}